\section{Patterns}
\label{sec:patterns}

This section covers how to use patterns and what they are used for. The operators
of a pattern looks like and behaves a little like regular expressions. This
grammar shows how a pattern is constructed:

\begin{ebnf}
\grule{pattern}{pattern\_expr \gcat \grep{pattern\_expr}}
\grule{pattern\_expr}{pattern\_val \gcat \gopt{\gter{*} \gor \gter{?} \gor \gter{+}}}
\galt{pattern\_val \gcat \gter{|} \gcat pattern\_expr}
\grule{pattern\_val}{direction}
\galt{variable}
\galt{pattern\_check}
\galt{\gter{!} \gcat pattern\_check}
\galt{\gter{(} \gcat pattern \gcat \gter{)} \gcat \gopt{integer}}
\grule{pattern\_check}{\gter{friend}}
\galt{\gter{foe}}
\galt{\gter{empty}}
\galt{\gter{this}}
\galt{type}
\end{ebnf}


A pattern is checked on a particular square, and returns either true or false.
An example of a pattern is \texttt{/n n e empty/}. This pattern can be checked on
the board seen in \figref{fig:patternboard} on the field \textbf{A1}. The pattern
says ``move one square north, move one square north, move one square east, check if
square is empty''. This means that the square \textbf{B3} will be checked if it
is empty. Since the square is occupied by a piece, the pattern will return
false if checked on \textbf{A1}. However, the same pattern matched on
\textbf{C1} will return true since the square at \textbf{D3} is empty.

\fig[scale=1.5]{patternboard}{A simple 4 X 4 board with 3 pieces}

With this basic introduction to a simple pattern matching,
\tableref{table:pattern-example} briefly describes how the different pattern
operators work. For each operator an example of the use in a context is given
in \secref{sec:patternexamples}. Note that the description of patterns assumes a
minor understanding of regular expressions, see \cite{regex}.

\tab[10cm]{pattern-example}{1}{Pattern operators.}{}
         {Pattern operator                       }{\textbf{Explanation}}{
  \tabrow{\texttt{empty}                         }{current square contains no
  pieces}
  \tabrow{\texttt{n}                             }{north}
  \tabrow{\texttt{e}                             }{east}
  \tabrow{\texttt{s}                             }{south}
  \tabrow{\texttt{w}                             }{west}
  \tabrow{\texttt{*}                             }{zero-to-many times}
  \tabrow{\texttt{+}                             }{one-to-many times}
  \tabrow{\texttt{?}                             }{zero-or-many times}
  \tabrow{\texttt{|}                             }{or}
  \tabrow{\texttt{!}                             }{not}
  \tabrow{\texttt{(} \textit{pattern} \texttt{)} }{encapsulation}
  \tabrow{\texttt{friend}                        }{current square contains at
  least one friendly piece of the current player}
  \tabrow{\texttt{foe}                           }{current square contains at
  least one enemy piece of the current player}
  \tabrow{\texttt{type}                          }{the current square is of the
given type or a piece of the given type is residing on the current square}
  \tabrow{\texttt{this}                          }{current square contains the
  piece for which the check is being performed}
}

\subsection{Pattern examples}
\label{sec:patternexamples}
All these examples of pattern machings are performed on the board and pieces
seen in \figref{fig:patternboard}. For each operator two examples of a pattern
matching on a particular square is given. The first check returns true and the
second check false.

\begin{enumerate}[noitemsep]
  \item On \textbf{A1}: the pattern matching \texttt{/empty/} returns true because
    \textbf{A1} is empty
  \item On \textbf{B2}: the pattern matching \texttt{/empty/} returns false because
    \textbf{B2} is not empty
  \item On \textbf{A1}: the pattern matching \texttt{/n empty/} returns true
    because \textbf{A2} is empty
  \item On \textbf{B1}: the pattern matching \texttt{/n empty/} returns false
    because \textbf{B2} is not empty
  \item On \textbf{C3}: the pattern mathcing \texttt{/e empty/} returns true
    because \textbf{C4} is empty
  \item On \textbf{C4}: the pattern matching \texttt{/e empty/} returns false
    because \textbf{C5} is out of board
  \item On \textbf{A1}: the pattern matching \texttt{/n* n e empty/} returns true
    because moving north 2 times then north and east hits an empty square on
    \textbf{B4}
\end{enumerate}

Notice that the \texttt{*}-operator causes many branches to be made. The
previous pattern \texttt{/n* n e empty/} done on \textbf{A1}, has a branch checking
\texttt{/n e empty/}. The branch dies because \textbf{B2} is not empty. If just one
branch survives, the pattern matching returns true. In the example, the only branch
surviving is the \texttt{n n n e empty} branch. The same rules for branching
counts for the \texttt{+}, \texttt{?}, and \texttt{|} operators. When a branch
moves out of board it dies immediately.

\begin{enumerate}[noitemsep,resume]
  \item On \textbf{C3}: the pattern matching \texttt{/n* s s !empty/} returns
    false because neither \textbf{A1} nor \textbf{A2} contains a piece
  \item On \textbf{A1}: the pattern matching \texttt{/n+ e empty/} returns true
    only because \textbf{B4} is empty. Notice how this pattern matching is
    equivalent to the pattern matching in bullet 7
  \item On \textbf{B1}: the pattern matching \texttt{/n+ empty e !empty/}
    returns false because \textbf{B4} is the only empty square north of
    \textbf{B1} and \textbf{C4} is empty
  \item On \textbf{B3}: the pattern matching \texttt{/s? e empty/} returns true
    only because \textbf{C2} is empty 
  \item On \textbf{C2}: the pattern matching \texttt{/n? w empty/} returns false
    because neither \textbf{B2} nor \textbf{B3} is empty
  \item On \textbf{A2}: the pattern matching \texttt{/(n | e) empty/} returns
    true only because \textbf{A3} is empty
  \item On \textbf{C2}: the pattern matching \texttt{/e | w empty/} returns
    false because neither \textbf{B2} nor \textbf{C3} is empty
  \item On \textbf{B1}: the pattern matching \texttt{/(n n | e e) empty/}
    returns true only because \textbf{D1} is empty
  \item On \textbf{A1}: the pattern matching \texttt{/(n w)* empty/} returns
    true both because \textbf{A1} is empty and because D4 is empty
\end{enumerate}

\subsubsection{Pattern keywords}

The \texttt{friend} keyword is evaluated based on the current player. Suppose
that we have a player called Green, who owns the green piece. If it is Green's
turn to move, any branch of a pattern matching will return false whenever it
meets a keyword \texttt{friend} on a square that does not contain any of Green's
pieces. On \textbf{B2}, the pattern matching \texttt{/n | e | (n e) friend/}
will return true if it is Green's turn, since \textbf{C3} contains a friendly
piece of Green. On \textbf{C3}, the pattern matching \texttt{/(e | w)+/} will
return false if it is Green's turn, since no square containing a green piece can
be reached by going east or west from \textbf{C3} one or more times.

The \texttt{foe} keyword does the opposite of \texttt{friend}. It makes a branch
continue only if its current square contains at least one piece not owned by the
player who has the turn.

Just like \texttt{foe} and \texttt{friend}, the name of a piece or square type
defined in a \productname{} game can also be used. E.g. the keyword
\texttt{White} can be used if a piece or square type with the name has been
defined. In such a case, a branch survives only if its current square is of type
\textit{White} or if the square contains a piece of type \textit{White}.

A pattern can also match if a specific piece exists on a specific square. This
is done using the \texttt{this} keyword. Before this mathcing can be achieved,
the pattern must be matched regarding to a specific piece. Suppose that we on
\textbf{A3} make the pattern matching \texttt{/empty e this/}. If this matching
is done in relation to the black piece on \textbf{B3} it returns true. However,
in relation to the black piece on \textbf{B2}, the pattern matching returns
alse. 

To understand how this function exactly works and why this is useful, consider
the board in \figref{fig:patternboard}. If we for any piece specify that it can
move to a square for which the pattern matching \texttt{/(n | s) empty/} is
true, this means that it can move to any square except $\mathbf{\left\{B1, B4,
C4\right\}}$. These squares do not have an empty square north or east from them.
Recall that a branch going out of board dies.  However, the pattern matching
\texttt{/empty (n | s) this/} will in relation to the green piece return true
only when matched on the squares $\mathbf{\left\{ C2, C4\right\}}$.  This can be
used to specify that a piece can move to an empty square one north or one south
from its current square. 

